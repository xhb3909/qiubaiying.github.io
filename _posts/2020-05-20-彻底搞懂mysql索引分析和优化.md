---
layout:     post
title:      彻底搞懂mysql索引分析和优化
date:       2020-05-20
author:     xhb
header-img: img/home-bg.jpg
catalog: true
sid: 2020520
tags:
    - mysql
---

# mysql架构与索引
今天想和大家分享的话题是, mysql常见索引分析与优化。

### mysql架构介绍
mysql是一个关系型数据库，由瑞典MYSQL AB公司开发，目前属于Oracle公司。支持大型数据库，支持几千万条记录的数据仓库，32位系统表文件最大可支持4GB，
64位系统支持最大的表文件为8TB。

#### mysql配置文件
* 二进制bin-log: 主从复制和备份恢复
* 错误日志error-log: 默认关闭，记录严重的警告和错误信息
* 慢查询日志log: 默认关闭，记录查询的sql语句。开启会降低mysql整体性能.
* `myisam`存放方式
> frm文件(framework) (存放表结构)

> myd文件(data) (存放表数据)

> myi文件(index) (存放表索引)

* `innodb`存放方式
> `ibdata1` 如果没有开启innodb_file_per_table=on参数，则默认将所有表的数据都存在 `/usr/share/mysql/iddata1`目录下

> frm文件 存放表结构 (存放在库同名的包目录下)

> 单独存放 开启innodb_file_per_table参数配置，会单独以 table名.ibd 的文件名存储

#### mysql逻辑架构
![架构1](https://pic.kuaizhan.com/g3/15/8c/1df8-02ce-4728-a1b8-5e75871e04ca78)

![架构2](https://pic.kuaizhan.com/g3/48/4f/34f0-c43f-4a0c-b9d8-581381e4716d20)
mysql插件式的存储引擎架构将查询处理和其它的系统任务以及数据的存储提取相分离。

* 连接层
> 连接层是一些客户端和连接服务，本地客户端工具实现的类似TCP/IP的通信.完成一些连接处理、授权认证的安全方案。该层上引入了线程池的
概念，为通过认证安全接入的客户端提供线程。

* 服务层
> Management Services & Utilities: 系统管理和控制工具.

> SQL Interface: 接受用户输入的sql命令，返回用户需要查询的结果.

> Parser 解析器: sql命令传递到解析器的时候会被解析器验证和解析.

> Optimizer 查询优化器: sql语句在查询之前会使用查询优化器对查询进行优化.

> Cache和Buffer 查询缓存: 如果查询缓存有命中的查询结果，查询语句就可以直接去查询缓存中取数据。

* 引擎层
> 存储引擎层，存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API与存储引擎进行通信。不同的存储引擎具有的功能不同

* 存储层
> 数据存储层，主要是将数据存储在运行于某个设备的文件系统之上，并完成与存储引擎的交互。

----------------------

mysql查询流程

```
 
mysql的查询流程大致是：
mysql客户端通过协议与mysql服务器建连接，发送查询语句，先检查查询缓存，如果命中(一模一样的sql才能命中)，直接返回结果，否则进行语句解析。
在解析查询之前，服务器会先访问查询缓存(query cache)——它存储SELECT语句以及相应的查询结果集。如果某个查询结果已经位于缓存中，服务器就不会再对查询进行解析、优化、以及执行。
它仅仅将缓存中的结果返回给用户即可，这将大大提高系统的性能。
 
语法解析器和预处理：首先mysql通过关键字将SQL语句进行解析，并生成一颗对应的'解析树'。
mysql解析器将使用mysql语法规则验证和解析查询: 预处理器则根据一些mysql规则进一步检查解析树是否合法。
 
查询优化器当解析树被认为是合法的了，并且由优化器将其转化成执行计划。一条查询可以有很多种执行方式，最后都返回相同的结果。
优化器的作用就是找到这其中最好的执行计划。
 
然后，mysql默认使用的BTREE索引。 无论如何分析，至少在目前来说，mysql最多只用到表中的一个索引。

```
 
#### mysql存储引擎
mysql存储引擎有很多。但是比较重要的存储引擎就是InnoDB和MyISAM

* InnoDB引擎
> InnoDB是MySQL的默认事务型引擎，它被设计用来处理大量的短期(short-lived)事务。
除非有非常特别的原因需要使用其他的存储引擎，否则应该优先考虑InnoDB引擎。行级锁，适合高并发情况

* `MyISAM`存储引擎
> `MyISAM`提供了大量的特性，包括全文索引、压缩、空间函数(GIS)等，但`MyISAM`不支持事务和行级锁(`myisam`改表时会将整个表全锁住)，崩溃后无法安全恢复。

* Archive引擎
> Archive存储引擎只支持INSERT和SELECT操作，在MySQL5.1之前不支持索引。
  Archive表适合日志和数据采集类应用。适合低访问量大数据等情况。Archive表比MyISAM表要小大约75%，比支持事务处理的InnoDB表小大约83%。

* `Blackhole`引擎
> `Blackhole`引擎没有实现任何存储机制，它会丢弃所有插入的数据，不做任何保存。但服务器会记录`Blackhole`表的日志，所以可以用于复制数据到备库，
  或者简单地记录到日志。但这种应用方式会碰到很多问题，因此并不推荐。
  
* CSV引擎
> CSV引擎可以将普通的CSV文件作为MySQL的表来处理，但不支持索引。
  CSV引擎可以作为一种数据交换的机制，非常有用。
  CSV存储的数据直接可以在操作系统里，用文本编辑器，或者excel读取。  
  
* Memory引擎
> 如果需要快速地访问数据，并且这些数据不会被修改，重启以后丢失也没有关系，
那么使用Memory表是非常有用。Memory表至少比MyISAM表要快一个数量级。(使用专业的内存数据库更快，如redis)

* Federated引擎
> Federated引擎是访问其他MySQL服务器的一个代理，尽管该引擎看起来提供了一种很好的跨服务器的灵活性，但也经常带来问题，因此默认是禁用的。

------------------


`Myisam` 和 `innoDB` PK

```
        MyISAM                                      I       InnoDB 

主外键   不支持                                               支持
事务     不支持                                               支持
行表锁   表锁，操作一条记录也会锁住整个表，不适合高并发的操作.       行锁,操作时只锁某一行，不对其它行有影响，适合高并发的操作
缓存    只缓存索引，不缓存真实数据                               不仅缓存索引还要缓存真实数据，对内存要求较高，而且内存大小对性能有决定性的影响
表空间  小                                                    大   
关注点 性能                                                   事务
索引   B-tree                                                B+tree 
```

### mysql索引优化分析

有些时候对于我们开发人员来说对mysql进行优化，主要还是优化sql。sql慢就会导致执行时间和等待的时间过长。

导致sql慢可能有以下几个原因:
* 查询数据过多
* 关联了太多的表，太多join
* 没有利用到索引
* 服务器调优

     
